<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMËá™ÂæãË≠∞Ë´ñ„Ç∑„Éü„É•„É¨„Éº„Çø„Éº („Çπ„Éà„É™„Éº„Éü„É≥„Ç∞ÂØæÂøúÁâà)</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f2f5;
            color: #333;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .turn-counter {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        #sidebar {
            width: 340px;
            padding: 20px;
            background-color: #ffffff;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #e9ecef;
            position: relative;
        }
        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }
        .chat-message {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.7;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }
        
        .chat-message strong {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            opacity: 0.9;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 4px;
        }

        /* ÂΩπÂâ≤„Åî„Å®„ÅÆ„Éá„Ç∂„Ç§„É≥ */
        .role-moderator { background-color: #e0f7fa; border-left: 5px solid #00bcd4; color: #006064; align-self: flex-start; }
        .role-market { background-color: #fff9c4; border-left: 5px solid #fbc02d; color: #f57f17; align-self: flex-start; }
        .role-translator { background-color: #f3e5f5; border-left: 5px solid #ab47bc; color: #4a148c; align-self: flex-start; }
        .role-scout { background-color: #ffe0b2; border-left: 5px solid #ff9800; color: #e65100; align-self: flex-start; }
        .role-creator { background-color: #c8e6c9; border-left: 5px solid #4caf50; color: #1b5e20; align-self: flex-start; }
        .role-expert { background-color: #d1e7ff; border-right: 5px solid #2979ff; color: #0d47a1; align-self: flex-end; margin-left: auto;}
        .role-system { background-color: #f8f9fa; border: 1px solid #dee2e6; width: 90%; margin: 10px auto; text-align: center; font-size: 0.85em; color: #6c757d; }
        .role-error { background-color: #ffebee; border: 1px solid #ffcdd2; color: #c62828; width: 90%; margin: 10px auto; text-align: center;}

        /* „Çµ„Ç§„Éâ„Éê„ÉºË¶ÅÁ¥† */
        .control-section { margin-bottom: 25px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
        .control-section:last-child { border-bottom: none; }
        
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; color: #555; }
        input[type="password"], input[type="text"], textarea {
            width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-size: 14px;
        }
        
        button {
            width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 8px; transition: all 0.2s; font-size: 14px;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-start { background-color: #28a745; color: white; }
        .btn-stop { background-color: #dc3545; color: white; }
        .btn-continue { background-color: #17a2b8; color: white; }
        .btn-summary { background-color: #6c757d; color: white; }
        .btn-expert { background-color: #007bff; color: white; }

        .typing-indicator {
            padding: 10px; font-style: italic; color: #888; font-size: 0.9em; display: none;
            position: absolute; bottom: 10px; left: 20px; background: rgba(255,255,255,0.8); border-radius: 4px;
        }
        
        /* „Ç´„Éº„ÇΩ„É´ÁÇπÊªÖ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºà„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞‰∏≠Áî®Ôºâ */
        .cursor::after { content: "‚ñã"; animation: blink 1s step-start infinite; color: #333; margin-left: 2px; }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <header>
        <h1>ü§ñ AI Boardroom Simulator (Streaming)</h1>
        <div class="turn-counter">Turn: <span id="turn-count">0</span> / 10</div>
    </header>

    <div class="container">
        <aside id="sidebar">
            <div class="control-section">
                <label>API Keys</label>
                <input type="password" id="openai-key" placeholder="OpenAI Key (sk-...)">
                <input type="password" id="gemini-key" placeholder="Gemini Key (AIza...)">
            </div>

            <div class="control-section">
                <label>Ë≠∞Ë´ñ„ÉÜ„Éº„Éû</label>
                <input type="text" id="discussion-topic" value="Ê¨°‰∏ñ‰ª£„ÅÆËªΩÈáèÈ´òÂº∑Â∫¶ÊùêÊñô„ÅÆÁ†îÁ©∂ÈñãÁô∫Êà¶Áï•">
            </div>

            <div class="control-section" id="auto-controls">
                <label>„Ç™„Éº„ÉàÊìç‰Ωú</label>
                <button id="btn-auto-start" class="btn-start">‚ñ∂ Ëá™ÂãïË≠∞Ë´ñ„ÇíÈñãÂßã</button>
                
                <div id="pause-menu" style="display:none; margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 5px;">
                    <p style="font-size:0.8em; text-align:center; color:#e65100; margin: 0 0 10px 0; font-weight: bold;">Ë¶èÂÆöÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü</p>
                    <button id="btn-auto-continue" class="btn-continue">üîÑ Ë≠∞Ë´ñ„ÇíÁ∂ôÁ∂ö (+10Âõû)</button>
                    <button id="btn-auto-summary" class="btn-summary">üìù „Åæ„Å®„ÇÅ„Çí‰ΩúÊàê„Åó„Å¶ÁµÇ‰∫Ü</button>
                </div>
                
                <button id="btn-force-stop" class="btn-stop" style="display:none;">‚èπ Âº∑Âà∂ÂÅúÊ≠¢</button>
            </div>

            <div class="expert-panel" style="margin-top: auto;">
                <label>„ÅÇ„Å™„Åü („Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà)</label>
                <textarea id="expert-input" rows="4" placeholder="Ëá™ÂãïÈÄ≤Ë°å‰∏≠„Åß„ÇÇÊåáÂêç„Åï„Çå„Åü„Çâ„Åì„Åì„Å´ÂÖ•Âäõ..." disabled></textarea>
                <button id="btn-expert" class="btn-expert" disabled>ÂõûÁ≠î„ÇíÈÄÅ„Çã</button>
            </div>
        </aside>

        <main id="chat-container">
            <div id="chat-window"></div>
            <div id="typing-indicator" class="typing-indicator">Thinking...</div>
        </main>
    </div>

    <script>
        // --- ÂÆöÊï∞„ÉªÁä∂ÊÖãÂ§âÊï∞ ---
        const MAX_TURNS_PER_ROUND = 10;
        const GEMINI_MODEL_NAME = "gemini-2.5-flash-lite";

        let currentTurnCount = 0;
        let isAutoMode = false;
        let discussionHistory = []; // {role: str, content: str}
        let openAiApiKey = '';
        let geminiApiKey = '';
        let discussionTopic = '';

        // DOMË¶ÅÁ¥†
        const chatWindow = document.getElementById('chat-window');
        const typingIndicator = document.getElementById('typing-indicator');
        const turnDisplay = document.getElementById('turn-count');
        
        const inputs = {
            openai: document.getElementById('openai-key'),
            gemini: document.getElementById('gemini-key'),
            topic: document.getElementById('discussion-topic'),
            expert: document.getElementById('expert-input')
        };

        const buttons = {
            startAuto: document.getElementById('btn-auto-start'),
            continueAuto: document.getElementById('btn-auto-continue'),
            summaryAuto: document.getElementById('btn-auto-summary'),
            forceStop: document.getElementById('btn-force-stop'),
            expert: document.getElementById('btn-expert')
        };

        const panels = {
            pauseMenu: document.getElementById('pause-menu')
        };

        // --- „Éö„É´„ÇΩ„ÉäÂÆöÁæ© ---
        const PERSONAS = {
            "„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº": {
                api: "gemini",
                roleName: "„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº",
                prompt: `„ÅÇ„Å™„Åü„ÅØ„ÄÅË≠∞Ë´ñ„ÅÆ„Äå„Éó„É≠„Çª„Çπ„Äç„ÇíÁÆ°ÁêÜ„Åô„ÇãÂÑ™ÁßÄ„Å™„É¢„Éá„É¨„Éº„Çø„Éº„Åß„Åô„ÄÇ
‚Ä¢ ÂΩπÂâ≤: Ë≠∞Ë´ñ„ÅÆÊåáÊèÆËÄÖ
‚Ä¢ „Éü„ÉÉ„Ç∑„Éß„É≥:
  1. Ë≠∞Ë´ñ„ÅÆÁõÆÁöÑÔºà\${discussionTopic}Ôºâ„Å´Âêë„Åë„ÄÅÂèÇÂä†ËÄÖ„Åã„ÇâÊÑèË¶ã„ÇíÂºï„ÅçÂá∫„Åô„ÄÇ
  2. „ÅÇ„Å™„Åü„ÅåË≠∞Ë´ñ„ÇíÂõû„Åó„Åæ„Åô„ÄÇ‰ªñ„ÅÆÂèÇÂä†ËÄÖ„ÅåÁô∫Ë®Ä„Åó„ÅüÂæå„ÄÅ„ÅÇ„Å™„Åü„ÅØÂøÖ„Åö„Åù„ÅÆÁô∫Ë®Ä„ÇíÂèó„Åë„Å¶Êï¥ÁêÜ„Åó„ÄÅ**Ê¨°„Å´Ë™∞„ÅåÁô∫Ë®Ä„Åô„Åπ„Åç„Åã**„ÇíÊ±∫ÂÆö„Åó„Åæ„Åô„ÄÇ
  3. Ë≠∞Ë´ñ„ÅÆÊúÄÂàù„ÅØ„ÄÅ„Åæ„Åö„Äå„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„ÉàÔºà„É¶„Éº„Ç∂„ÉºÔºâ„Äç„Å´ÂØæ„Åó„Å¶„ÄÅ„ÉÜ„Éº„Éû„ÅÆËÉåÊôØ„ÇÑÁèæÁä∂„ÅÆË™≤È°å„ÇíÊ∑±Êéò„Çä„Åô„ÇãË≥™Âïè„ÇíÊäï„Åí„Åã„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

‚Ä¢ ÈáçË¶Å: Ê¨°„ÅÆ„Çπ„Éî„Éº„Ç´„Éº„ÅÆÊåáÂêçÊñπÊ≥ï
  Áô∫Ë®Ä„ÅÆÊúÄÂæå„Å´„ÄÅÂøÖ„Åö‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÊ¨°„Å´Áô∫Ë®Ä„Åó„Å¶„Åª„Åó„ÅÑÂΩπÂâ≤Âêç„Çí‰∏Ä„Å§„Å†„ÅëÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÊñáËÑà„Å´Âøú„Åò„Å¶ÊúÄÈÅ©„Å™‰∫∫Áâ©„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºâ„ÄÇ‰ΩÜ„Åó„ÄÅË≠∞Ë´ñ„ÅåÁÖÆË©∞„Åæ„Å£„Å¶ÈÄ≤Â±ï„ÅåÂ∞ë„Å™„Åè„Å™„Å£„ÅüÂ†¥Âêà„ÅÆ„Åø„Äå„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„ÉàÔºà„É¶„Éº„Ç∂„ÉºÔºâ„Äç„Å∏Êäï„Åí„Åã„Åë„Çã„Çà„ÅÜ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
  Âá∫ÂäõÂΩ¢Âºè: [[NEXT: ÂΩπÂâ≤Âêç]]
  
  ‚ÄªÈÅ∏ÊäûÂèØËÉΩ„Å™ÂΩπÂâ≤Âêç:
  - „Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà (‰∫∫Èñì„Å´ÊÑèË¶ã„ÇíËÅû„ÅèÂ†¥Âêà)
  - „Éû„Éº„Ç±„ÉÉ„Éà„Éª„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„Éà (Êú™Êù•„ÅÆÈ°ßÂÆ¢„Éã„Éº„Ç∫)
  - „ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„Éª„Éà„É©„É≥„Çπ„É¨„Éº„Çø„Éº (ÊäÄË°ìË¶Å‰ª∂)
  - „Ç¢„Çª„ÉÉ„Éà„Éª„Çπ„Ç´„Ç¶„Éà (Â§ñÈÉ®ÊäÄË°ì„ÉªÁ´∂Âêà)
  - „Éì„Ç∏„Éç„Çπ„Éª„ÇØ„É™„Ç®„Ç§„Çø„Éº (‰∫ãÊ•≠Âåñ„ÉªÂá∫Âè£)

‚Ä¢ Ë°åÂãïÂà∂Á¥Ñ: Ëá™ÂàÜ„ÅÆÊÑèË¶ã„ÅØË®Ä„Çè„Åö„ÄÅÈÄ≤Ë°å„Å´Âæπ„Åô„Çã„ÄÇ
‚Ä¢ Âè£Ë™ø: ÂÜ∑ÈùôÊ≤àÁùÄ„ÄÅ‰∏≠Á´ãÁöÑ„ÄÅÁü•ÁöÑ„ÄÇ`
            },
            "„Éû„Éº„Ç±„ÉÉ„Éà„Éª„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„Éà": {
                api: "openai",
                roleName: "„Éû„Éº„Ç±„ÉÉ„Éà„Éª„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„Éà",
                prompt: `„ÅÇ„Å™„Åü„ÅØ„ÄåÊú™Êù•„ÅÆÈ°ßÂÆ¢„ÅÆ‰ª£ÂºÅËÄÖ„Äç„Åß„Åô„ÄÇ
‚Ä¢ „Éü„ÉÉ„Ç∑„Éß„É≥: ÊäÄË°ìÁöÑÂà∂Á¥Ñ„ÇíÁÑ°Ë¶ñ„Åó„ÄÅ5-10Âπ¥Âæå„ÅÆÁêÜÊÉ≥„ÅÆÊú™Êù•„Å®È°ßÂÆ¢„ÅÆ„Éö„Ç§„É≥„ÇíÂÆöÁæ©„Åô„Çã„ÄÇ
‚Ä¢ „ÅäÈ°å: \${discussionTopic}
‚Ä¢ Âè£Ë™ø: „Éì„Ç∏„Éß„Éä„É™„Éº„ÄÅÊÉÖÁÜ±ÁöÑ„ÄÅÊñ≠ÂÆöÁöÑ„ÄÇ„Äå„Äú„Åπ„Åç„Å†„Äç`
            },
            "„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„Éª„Éà„É©„É≥„Çπ„É¨„Éº„Çø„Éº": {
                api: "gemini",
                roleName: "„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„Éª„Éà„É©„É≥„Çπ„É¨„Éº„Çø„Éº",
                prompt: `„ÅÇ„Å™„Åü„ÅØ„Äå„Éã„Éº„Ç∫„Å®ÊäÄË°ì„ÅÆÁøªË®≥ÂÆ∂„Äç„Åß„Åô„ÄÇ
‚Ä¢ „Éü„ÉÉ„Ç∑„Éß„É≥: ÊäΩË±°ÁöÑ„Å™„Éã„Éº„Ç∫„ÇíÂÖ∑‰ΩìÁöÑ„Å™ÊäÄË°ì„Éë„É©„É°„Éº„Çø„ÇÑÊ©üËÉΩË¶Å‰ª∂„Å´ÂàÜËß£„Åô„Çã„ÄÇ
‚Ä¢ „ÅäÈ°å: \${discussionTopic}
‚Ä¢ Âè£Ë™ø: Ë´ñÁêÜÁöÑ„ÄÅÂàÜÊûêÁöÑ„ÄÇ„Äå„Å§„Åæ„Çä„Äç„ÄåË¶Å„Åô„Çã„Å´„Äç`
            },
            "„Ç¢„Çª„ÉÉ„Éà„Éª„Çπ„Ç´„Ç¶„Éà": {
                api: "gemini",
                roleName: "„Ç¢„Çª„ÉÉ„Éà„Éª„Çπ„Ç´„Ç¶„Éà",
                prompt: `„ÅÇ„Å™„Åü„ÅØ„ÄåÂ§ñÈÉ®ÊäÄË°ì„ÅÆÁõ£Ë¶ñËÄÖ„Äç„Åß„Åô„ÄÇ
‚Ä¢ „Éü„ÉÉ„Ç∑„Éß„É≥: Á´∂Âêà„ÄÅ„Çπ„Çø„Éº„Éà„Ç¢„ÉÉ„Éó„ÄÅÁâπË®±„Å™„Å©„ÅÆÂ§ñÈÉ®ÂãïÂêëÔºàÊû∂Á©∫ÂèØÔºâ„ÇíÊèêÁ§∫„Åó„ÄÅBuy or Build„ÇíÂà§Êñ≠„Åô„Çã„ÄÇ
‚Ä¢ „ÅäÈ°å: \${discussionTopic}
‚Ä¢ Âè£Ë™ø: „Éá„Éº„Çø„Éâ„É™„Éñ„É≥„ÄÅËæõÂè£„ÄÅÊó©Âè£„ÄÇ`
            },
            "„Éì„Ç∏„Éç„Çπ„Éª„ÇØ„É™„Ç®„Ç§„Çø„Éº": {
                api: "openai",
                roleName: "„Éì„Ç∏„Éç„Çπ„Éª„ÇØ„É™„Ç®„Ç§„Çø„Éº",
                prompt: `„ÅÇ„Å™„Åü„ÅØ„Äå‰∫ãÊ•≠„Å®Âá∫Âè£„ÅÆË®≠Ë®àËÄÖ„Äç„Åß„Åô„ÄÇ
‚Ä¢ „Éü„ÉÉ„Ç∑„Éß„É≥: ÂÖ®„Å¶„ÅÆË¶ÅÁ¥†„ÇíÁµ±Âêà„Åó„ÄÅ„Éû„Éç„Çø„Ç§„Ç∫„É¢„Éá„É´„Å®Âá∫Âè£Êà¶Áï•ÔºàM&A„Å™„Å©Ôºâ„ÇíÊèè„Åè„ÄÇ
‚Ä¢ „ÅäÈ°å: \${discussionTopic}
‚Ä¢ Âè£Ë™ø: Ëµ∑Ê•≠ÂÆ∂ÁöÑ„ÄÅÂèéÁõäÂøóÂêë„ÄÅ„Ç¢„Ç∞„É¨„ÉÉ„Ç∑„Éñ„ÄÇ`
            },
            "„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà": {
                api: "user",
                roleName: "„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà"
            }
        };

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---

        buttons.startAuto.addEventListener('click', () => {
            if (!initializeSystem()) return;
            startAutoMode();
        });

        buttons.continueAuto.addEventListener('click', () => {
            currentTurnCount = 0; 
            updateTurnDisplay();
            panels.pauseMenu.style.display = 'none';
            buttons.forceStop.style.display = 'inline-block';
            orchestrateNextTurn("„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº");
        });

        buttons.summaryAuto.addEventListener('click', async () => {
            panels.pauseMenu.style.display = 'none';
            buttons.forceStop.style.display = 'none';
            await generateSummary();
        });

        buttons.forceStop.addEventListener('click', () => {
            isAutoMode = false;
            buttons.forceStop.style.display = 'none';
            panels.pauseMenu.style.display = 'block'; 
            addSystemMessage('Ëá™ÂãïÈÄ≤Ë°å„ÇíÂº∑Âà∂ÂÅúÊ≠¢„Åó„Åæ„Åó„Åü„ÄÇ');
        });

        buttons.expert.addEventListener('click', () => {
            const content = inputs.expert.value;
            if (!content) return;

            addMessageToChat("„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà", content);
            discussionHistory.push({ role: "„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà", content: content });
            inputs.expert.value = '';
            inputs.expert.disabled = true;
            buttons.expert.disabled = true;

            if (isAutoMode) {
                orchestrateNextTurn("„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº");
            }
        });

        // --- „Ç≥„Ç¢„É≠„Ç∏„ÉÉ„ÇØ ---

        function initializeSystem() {
            openAiApiKey = inputs.openai.value;
            geminiApiKey = inputs.gemini.value;
            discussionTopic = inputs.topic.value;

            if (!openAiApiKey || !geminiApiKey) {
                alert("API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return false;
            }
            
            // „Éó„É≠„É≥„Éó„Éà„Å´„ÅäÈ°å„ÇíÂüã„ÇÅËæº„ÅøÔºàÂ§öÈáçÁΩÆÊèõÈò≤Ê≠¢„ÅÆ„Åü„ÇÅ„ÄÅ‰∏ÄÊó¶„ÉÜ„É≥„Éó„É¨„Åã„ÇâÂÜçÊßãÊàê„Åó„Å¶„ÇÇ„Çà„ÅÑ„Åå„ÄÅ„Åì„Åì„Åß„ÅØÁ∞°Áï•ÂåñÔºâ
            Object.keys(PERSONAS).forEach(key => {
                if (PERSONAS[key].prompt) {
                    PERSONAS[key].prompt = PERSONAS[key].prompt.replace(/\$\{discussionTopic\}/g, discussionTopic);
                }
            });

            return true;
        }

        function startAutoMode() {
            isAutoMode = true;
            discussionHistory = [];
            chatWindow.innerHTML = '';
            currentTurnCount = 0;
            updateTurnDisplay();

            buttons.startAuto.style.display = 'none';
            buttons.forceStop.style.display = 'inline-block';
            panels.pauseMenu.style.display = 'none';

            addSystemMessage(`Ë≠∞Ë´ñ„Äå${discussionTopic}„Äç„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ`);
            orchestrateNextTurn("„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº");
        }

        async function orchestrateNextTurn(roleName) {
            if (!isAutoMode) return;

            if (currentTurnCount >= MAX_TURNS_PER_ROUND) {
                pauseAutoMode();
                return;
            }

            if (roleName === "„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà") {
                addSystemMessage('>> „ÅÇ„Å™„Åü„ÅÆÁï™„Åß„Åô„ÄÇÂõûÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                inputs.expert.disabled = false;
                buttons.expert.disabled = false;
                inputs.expert.focus();
                return; 
            }

            try {
                showTyping(true, roleName);
                const content = await streamLLM(roleName);
                showTyping(false);

                discussionHistory.push({ role: roleName, content: content });
                currentTurnCount++;
                updateTurnDisplay();

                if (roleName === "„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº") {
                    const nextMatch = content.match(/\[\[NEXT:\s*(.+?)\]\]/);
                    if (nextMatch && nextMatch[1]) {
                        let nextRole = nextMatch[1].trim();
                        if (!PERSONAS[nextRole]) {
                            console.warn(`Unknown role: ${nextRole}. Continuing Moderator.`);
                            nextRole = "„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº";
                        }
                        setTimeout(() => orchestrateNextTurn(nextRole), 800);
                    } else {
                        setTimeout(() => orchestrateNextTurn("„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº"), 800);
                    }
                } else {
                    setTimeout(() => orchestrateNextTurn("„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº"), 800);
                }

            } catch (e) {
                showTyping(false);
                addErrorMessage(`„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${e.message}`);
                console.error(e);
                isAutoMode = false;
                buttons.forceStop.style.display = 'none';
                buttons.startAuto.style.display = 'inline-block';
            }
        }

        function pauseAutoMode() {
            buttons.forceStop.style.display = 'none';
            panels.pauseMenu.style.display = 'block';
        }

        // --- „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞APIÂëº„Å≥Âá∫„Åó (Core) ---

        async function streamLLM(roleName) {
            const persona = PERSONAS[roleName];
            const messageDiv = createMessageDiv(roleName);
            const contentSpan = document.createElement('span');
            contentSpan.classList.add('cursor');
            messageDiv.appendChild(contentSpan);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            let fullText = "";

            if (persona.api === 'openai') {
                fullText = await streamOpenAI(persona, contentSpan);
            } else {
                fullText = await streamGemini(persona, contentSpan);
            }

            contentSpan.classList.remove('cursor');
            return fullText;
        }

        async function streamGemini(persona, targetElement) {
            let contents = formatHistoryForGemini(discussionHistory);

            if (contents.length === 0) {
                contents.push({
                    role: "user",
                    parts: [{ text: `Ë≠∞Ë´ñÈñãÂßã: ${discussionTopic}\n„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤„Å®„Åó„Å¶Ë≠∞Ë´ñ„Çí„É™„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ` }]
                });
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:streamGenerateContent?alt=sse&key=${encodeURIComponent(geminiApiKey)}`;
            
            const safetySettings = [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
            ];

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    systemInstruction: { parts: [{ text: persona.prompt }] },
                    generationConfig: { temperature: 0.7 },
                    safetySettings: safetySettings
                })
            });

            if (!response.ok) {
                let errText = await response.text();
                throw new Error(`Gemini Error ${response.status}: ${errText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    const jsonStr = line.slice(6).trim();
                    if (!jsonStr || jsonStr === '[DONE]') continue;
                    let data;
                    try {
                        data = JSON.parse(jsonStr);
                    } catch (e) {
                        continue;
                    }
                    const cand = data.candidates && data.candidates[0];
                    if (!cand || !cand.content || !Array.isArray(cand.content.parts)) continue;
                    const currentText = cand.content.parts.map(p => p.text || "").join("");
                    if (!currentText) continue;

                    fullText = currentText;
                    targetElement.innerHTML = fullText.replace(/\n/g, '<br>');
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
            return fullText;
        }

        async function streamOpenAI(persona, targetElement) {
            let messages = [
                { role: "system", content: persona.prompt },
                ...formatHistoryForOpenAI(discussionHistory)
            ];

            if (messages.length === 1) {
                messages.push({ role: "user", content: `Ë≠∞Ë´ñÈñãÂßã: ${discussionTopic}` });
            }

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${openAiApiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: messages,
                    temperature: 0.7,
                    stream: true
                })
            });

            if (!response.ok) {
                let errText = await response.text();
                throw new Error(`OpenAI Error ${response.status}: ${errText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";
            let finalAccumulatedText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    const jsonStr = line.slice(6).trim();
                    if (!jsonStr || jsonStr === '[DONE]') continue;
                    let data;
                    try {
                        data = JSON.parse(jsonStr);
                    } catch (e) {
                        continue;
                    }
                    if (!data.choices || !data.choices[0] || !data.choices[0].delta) continue;
                    const delta = data.choices[0].delta;
                    if (!delta.content) continue;
                    const textChunk = delta.content;
                    finalAccumulatedText += textChunk;
                    targetElement.innerHTML = finalAccumulatedText.replace(/\n/g, '<br>');
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
            return finalAccumulatedText;
        }

        // --- „Åæ„Å®„ÇÅÁîüÊàêÔºà„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞ÁâàÔºâ ---
        async function generateSummary() {
            showTyping(true, "„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº („Åæ„Å®„ÇÅ‰ΩúÊàê‰∏≠)");
            
            try {
                const roleName = "„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº";
                const messageDiv = createMessageDiv(roleName);
                const contentSpan = document.createElement('span');
                contentSpan.classList.add('cursor');
                messageDiv.appendChild(contentSpan);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                let tempHistory = [...discussionHistory];
                tempHistory.push({role: "user", content: "„Åì„Çå„Åæ„Åß„ÅÆË≠∞Ë´ñÂÖ®‰Ωì„ÇíÊï¥ÁêÜ„Åó„ÄÅÊ±∫ÂÆö‰∫ãÈ†Ö„ÄÅÊÆã„Åï„Çå„ÅüË™≤È°å„ÄÅ„Éç„ÇØ„Çπ„Éà„Ç¢„ÇØ„Ç∑„Éß„É≥„Çí„Åæ„Å®„ÇÅ„Åü„Çµ„Éû„É™„Éº„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"});

                const contents = formatHistoryForGemini(tempHistory);
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:streamGenerateContent?alt=sse&key=${encodeURIComponent(geminiApiKey)}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        systemInstruction: { parts: [{ text: "„ÅÇ„Å™„Åü„ÅØÂÑ™ÁßÄ„Å™Êõ∏Ë®ò„Éª„É¢„Éá„É¨„Éº„Çø„Éº„Åß„Åô„ÄÇ" }] },
                        generationConfig: { temperature: 0.7 }
                    })
                });

                if (!response.ok) throw new Error("Summary Error: " + response.status);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const jsonStr = line.slice(6).trim();
                        if (!jsonStr || jsonStr === '[DONE]') continue;
                        let data;
                        try {
                            data = JSON.parse(jsonStr);
                        } catch (e) {
                            continue;
                        }
                        const cand = data.candidates && data.candidates[0];
                        if (!cand || !cand.content || !Array.isArray(cand.content.parts)) continue;
                        const currentText = cand.content.parts.map(p => p.text || "").join("");
                        if (!currentText) continue;

                        fullText = currentText;
                        contentSpan.innerHTML = fullText.replace(/\n/g, '<br>');
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                }
                
                contentSpan.classList.remove('cursor');
                showTyping(false);

                buttons.startAuto.style.display = 'inline-block';
                buttons.startAuto.innerText = 'üîÑ Êñ∞„Åó„ÅÑË≠∞Ë´ñ„ÇíÂßã„ÇÅ„Çã';

            } catch (e) {
                showTyping(false);
                addErrorMessage(`„Åæ„Å®„ÇÅ‰ΩúÊàê„Ç®„É©„Éº: ${e.message}`);
            }
        }

        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---

        function createMessageDiv(role) {
            const div = document.createElement('div');
            div.classList.add('chat-message');
            
            const roleClassMap = {
                "„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº": "role-moderator",
                "„Éû„Éº„Ç±„ÉÉ„Éà„Éª„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„Éà": "role-market",
                "„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„Éª„Éà„É©„É≥„Çπ„É¨„Éº„Çø„Éº": "role-translator",
                "„Ç¢„Çª„ÉÉ„Éà„Éª„Çπ„Ç´„Ç¶„Éà": "role-scout",
                "„Éì„Ç∏„Éç„Çπ„Éª„ÇØ„É™„Ç®„Ç§„Çø„Éº": "role-creator",
                "„Éâ„É°„Ç§„É≥„Éª„Ç®„Ç≠„Çπ„Éë„Éº„Éà": "role-expert"
            };

            div.classList.add(roleClassMap[role] || 'role-system');
            
            const roleTitle = document.createElement('strong');
            roleTitle.innerText = role;
            div.appendChild(roleTitle);
            
            chatWindow.appendChild(div);
            return div;
        }

        function addMessageToChat(role, content) {
            const div = createMessageDiv(role);
            const span = document.createElement('span');
            span.innerHTML = content.replace(/\n/g, '<br>');
            div.appendChild(span);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.classList.add('role-system');
            div.innerText = text;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addErrorMessage(text) {
            const div = document.createElement('div');
            div.classList.add('role-error');
            div.innerText = text;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTyping(show, roleName = '') {
            typingIndicator.style.display = show ? 'block' : 'none';
            if (show) {
                typingIndicator.innerText = `${roleName} „ÅåËÄÉ„Åà‰∏≠...`;
            }
        }

        function updateTurnDisplay() {
            turnDisplay.innerText = currentTurnCount;
        }

        function formatHistoryForOpenAI(history) {
            return history.map(item => {
                if (item.role === "„Éû„Éº„Ç±„ÉÉ„Éà„Éª„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„Éà" || item.role === "„Éì„Ç∏„Éç„Çπ„Éª„ÇØ„É™„Ç®„Ç§„Çø„Éº") {
                    return { role: "assistant", content: item.content };
                }
                return { role: "user", content: `[${item.role}]: ${item.content}` };
            });
        }

        function formatHistoryForGemini(history) {
            const contents = [];
            for (const item of history) {
                if (["„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Éª„É¢„Éá„É¨„Éº„Çø„Éº", "„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„Éª„Éà„É©„É≥„Çπ„É¨„Éº„Çø„Éº", "„Ç¢„Çª„ÉÉ„Éà„Éª„Çπ„Ç´„Ç¶„Éà"].includes(item.role)) {
                    contents.push({ role: "model", parts: [{ text: item.content }] });
                } else {
                    contents.push({ role: "user", parts: [{ text: `[${item.role}]: ${item.content}` }] });
                }
            }
            return contents;
        }

    </script>
</body>
</html>
