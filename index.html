<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMè‡ªå¾‹è­°è«–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (å®‰å®šç‰ˆ v4)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f7f6;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .turn-counter {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        #sidebar {
            width: 320px;
            padding: 20px;
            background-color: #ffffff;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #e9ecef;
        }
        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }
        .chat-message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.6;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .chat-message strong { display: block; margin-bottom: 5px; font-size: 0.85em; opacity: 0.8; }
        
        /* å½¹å‰²ã”ã¨ã®è‰²åˆ†ã‘ */
        .role-moderator { background-color: #e0f7fa; border: 1px solid #b2ebf2; align-self: flex-start; color: #006064; }
        .role-market { background-color: #fff9c4; border: 1px solid #fff59d; align-self: flex-start; color: #f57f17; }
        .role-translator { background-color: #f3e5f5; border: 1px solid #e1bee7; align-self: flex-start; color: #4a148c; }
        .role-scout { background-color: #ffe0b2; border: 1px solid #ffcc80; align-self: flex-start; color: #e65100; }
        .role-creator { background-color: #c8e6c9; border: 1px solid #a5d6a7; align-self: flex-start; color: #1b5e20; }
        .role-expert { background-color: #d1e7ff; border: 1px solid #a8cfff; align-self: flex-end; color: #0d47a1; }
        .role-system { background-color: #f8f9fa; border: 1px solid #dee2e6; align-self: center; font-style: italic; font-size: 0.85em; color: #6c757d; width: 100%; text-align: center; }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼è¦ç´  */
        .control-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .control-section:last-child { border-bottom: none; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #333; }
        input[type="password"], input[type="text"], textarea {
            width: calc(100% - 16px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-size: 14px;
        }
        
        button {
            width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 8px; transition: all 0.2s;
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-start { background-color: #28a745; color: white; }
        .btn-stop { background-color: #dc3545; color: white; }
        .btn-continue { background-color: #17a2b8; color: white; }
        .btn-summary { background-color: #6c757d; color: white; }
        .btn-manual { background-color: #f8f9fa; border: 1px solid #ddd; color: #333; font-weight: normal; font-size: 0.9em; }
        
        .expert-panel { border-top: 2px solid #007bff; padding-top: 15px; margin-top: auto; }
        .btn-expert { background-color: #007bff; color: white; }

        /* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .typing-indicator { font-size: 0.8em; color: #888; text-align: center; margin-top: 10px; display: none; }
        .retry-indicator { color: #e65100; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ¤– AI Boardroom Simulator (v4)</h1>
        <div class="turn-counter">Turn: <span id="turn-count">0</span> / 10</div>
    </header>

    <div class="container">
        <aside id="sidebar">
            <div class="control-section">
                <label>API Keys</label>
                <input type="password" id="openai-key" placeholder="OpenAI Key (sk-...)">
                <input type="password" id="gemini-key" placeholder="Gemini Key (AIza...)">
            </div>

            <div class="control-section">
                <label>è­°è«–ãƒ†ãƒ¼ãƒ</label>
                <input type="text" id="discussion-topic" value="æ¬¡ä¸–ä»£ã®è»½é‡é«˜å¼·åº¦ææ–™ã®ç ”ç©¶é–‹ç™ºæˆ¦ç•¥">
            </div>

            <div class="control-section" id="auto-controls">
                <label>ã‚ªãƒ¼ãƒˆæ“ä½œ</label>
                <button id="btn-auto-start" class="btn-start">â–¶ è‡ªå‹•è­°è«–ã‚’é–‹å§‹</button>
                <div id="pause-menu" style="display:none;">
                    <p style="font-size:0.8em; text-align:center; color:#e65100;">è¦å®šå›æ•°ã«é”ã—ã¾ã—ãŸ</p>
                    <button id="btn-auto-continue" class="btn-continue">ğŸ”„ è­°è«–ã‚’ç¶™ç¶š (+10å›)</button>
                    <button id="btn-auto-summary" class="btn-summary">ğŸ“ ã¾ã¨ã‚ã‚’ä½œæˆã—ã¦çµ‚äº†</button>
                </div>
                <button id="btn-force-stop" class="btn-stop" style="display:none;">â¹ å¼·åˆ¶åœæ­¢</button>
            </div>

            <div class="control-section">
                <label>æ‰‹å‹•æ“ä½œãƒ»çŠ¶æ³ç¢ºèª</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <button id="btn-moderator" class="btn-manual" disabled>Moderator</button>
                    <button id="btn-market" class="btn-manual" disabled>Market Arch.</button>
                    <button id="btn-translator" class="btn-manual" disabled>Tech Trans.</button>
                    <button id="btn-scout" class="btn-manual" disabled>Asset Scout</button>
                    <button id="btn-creator" class="btn-manual" disabled>Biz Creator</button>
                </div>
            </div>

            <div class="expert-panel">
                <label>ã‚ãªãŸ (ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ)</label>
                <textarea id="expert-input" placeholder="è‡ªå‹•é€²è¡Œä¸­ã§ã‚‚æŒ‡åã•ã‚ŒãŸã‚‰ã“ã“ã«å…¥åŠ›..." disabled></textarea>
                <button id="btn-expert" class="btn-expert" disabled>å›ç­”ã‚’é€ã‚‹</button>
            </div>
        </aside>

        <main id="chat-container">
            <div id="chat-window"></div>
            <div id="typing-indicator" class="typing-indicator">Thinking...</div>
        </main>
    </div>

    <script>
        // --- å®šæ•°ãƒ»çŠ¶æ…‹å¤‰æ•° ---
        const MAX_TURNS_PER_ROUND = 10;
        // ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ gemini-1.5-pro ã‚„ gemini-1.5-flash ã«å¤‰æ›´ã—ã¦ãã ã•ã„
        const GEMINI_MODEL_NAME = "gemini-2.5-pro"; 

        let currentTurnCount = 0;
        let isAutoMode = false;
        let discussionHistory = [];
        let openAiApiKey = '';
        let geminiApiKey = '';
        let discussionTopic = '';

        // DOMè¦ç´ 
        const chatWindow = document.getElementById('chat-window');
        const typingIndicator = document.getElementById('typing-indicator');
        const turnDisplay = document.getElementById('turn-count');
        
        const inputs = {
            openai: document.getElementById('openai-key'),
            gemini: document.getElementById('gemini-key'),
            topic: document.getElementById('discussion-topic'),
            expert: document.getElementById('expert-input')
        };

        const buttons = {
            startAuto: document.getElementById('btn-auto-start'),
            continueAuto: document.getElementById('btn-auto-continue'),
            summaryAuto: document.getElementById('btn-auto-summary'),
            forceStop: document.getElementById('btn-force-stop'),
            expert: document.getElementById('btn-expert'),
            manual: {
                moderator: document.getElementById('btn-moderator'),
                market: document.getElementById('btn-market'),
                translator: document.getElementById('btn-translator'),
                scout: document.getElementById('btn-scout'),
                creator: document.getElementById('btn-creator')
            }
        };

        const panels = {
            pauseMenu: document.getElementById('pause-menu')
        };

        // --- ãƒšãƒ«ã‚½ãƒŠå®šç¾© ---
        const PERSONAS = {
            "ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼": {
                api: "gemini",
                roleName: "ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼",
                prompt: `ã‚ãªãŸã¯ã€è­°è«–ã®ã€Œãƒ—ãƒ­ã‚»ã‚¹ã€ã‚’ç®¡ç†ã™ã‚‹å„ªç§€ãªãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚
â€¢ å½¹å‰²: è­°è«–ã®æŒ‡æ®è€…
â€¢ ãƒŸãƒƒã‚·ãƒ§ãƒ³:
  1. è­°è«–ã®ç›®çš„ï¼ˆ\${discussionTopic}ï¼‰ã«å‘ã‘ã€å‚åŠ è€…ã‹ã‚‰æ„è¦‹ã‚’å¼•ãå‡ºã™ã€‚
  2. ã‚ãªãŸãŒè­°è«–ã‚’å›ã—ã¾ã™ã€‚ä»–ã®å‚åŠ è€…ãŒç™ºè¨€ã—ãŸå¾Œã€ã‚ãªãŸã¯å¿…ãšãã®ç™ºè¨€ã‚’å—ã‘ã¦æ•´ç†ã—ã€**æ¬¡ã«èª°ãŒç™ºè¨€ã™ã¹ãã‹**ã‚’æ±ºå®šã—ã¾ã™ã€‚
  3. è­°è«–ã®æœ€åˆã¯ã€ã¾ãšã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã€ã«å¯¾ã—ã¦ã€ãƒ†ãƒ¼ãƒã®èƒŒæ™¯ã‚„ç¾çŠ¶ã®èª²é¡Œã‚’æ·±æ˜ã‚Šã™ã‚‹è³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ãã ã•ã„ã€‚

â€¢ é‡è¦: æ¬¡ã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®æŒ‡åæ–¹æ³•
  ç™ºè¨€ã®æœ€å¾Œã«ã€å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§æ¬¡ã«ç™ºè¨€ã—ã¦ã»ã—ã„å½¹å‰²åã‚’ä¸€ã¤ã ã‘æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
  å‡ºåŠ›å½¢å¼: [[NEXT: å½¹å‰²å]]
  
  â€»é¸æŠå¯èƒ½ãªå½¹å‰²å:
  - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ (ã‚‚ã—äººé–“ã«æ„è¦‹ã‚’èããŸã„å ´åˆ)
  - ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ (æœªæ¥ã®é¡§å®¢ãƒ‹ãƒ¼ã‚º)
  - ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ¼ (æŠ€è¡“è¦ä»¶ã¸ã®åˆ†è§£)
  - ã‚¢ã‚»ãƒƒãƒˆãƒ»ã‚¹ã‚«ã‚¦ãƒˆ (å¤–éƒ¨æŠ€è¡“ã‚„ç«¶åˆå‹•å‘)
  - ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ (äº‹æ¥­åŒ–ã¨å‡ºå£æˆ¦ç•¥)

â€¢ è¡Œå‹•åˆ¶ç´„:
  - è‡ªåˆ†ã®æ„è¦‹ã¯è¨€ã‚ãšã€é€²è¡Œã«å¾¹ã™ã‚‹ã€‚
  - ç‰¹å®šã®æŠ€è¡“è©³ç´°ã«ã¯æ·±å…¥ã‚Šã—ãªã„ã€‚
â€¢ å£èª¿: å†·é™æ²ˆç€ã€ä¸­ç«‹çš„ã€çŸ¥çš„ã€‚`
            },
            "ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ": {
                api: "openai",
                roleName: "ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ",
                prompt: `ã‚ãªãŸã¯ã€Œæœªæ¥ã®é¡§å®¢ã®ä»£å¼è€…ã€ã§ã™ã€‚
â€¢ ãƒŸãƒƒã‚·ãƒ§ãƒ³: æŠ€è¡“çš„åˆ¶ç´„ã‚’ç„¡è¦–ã—ã€5-10å¹´å¾Œã®ç†æƒ³ã®æœªæ¥ã¨é¡§å®¢ã®ãƒšã‚¤ãƒ³ã‚’å®šç¾©ã™ã‚‹ã€‚
â€¢ ãŠé¡Œ: \${discussionTopic}
â€¢ å£èª¿: ãƒ“ã‚¸ãƒ§ãƒŠãƒªãƒ¼ã€æƒ…ç†±çš„ã€æ–­å®šçš„ã€‚ã€Œã€œã¹ãã ã€`
            },
            "ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ¼": {
                api: "gemini",
                roleName: "ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ¼",
                prompt: `ã‚ãªãŸã¯ã€Œãƒ‹ãƒ¼ã‚ºã¨æŠ€è¡“ã®ç¿»è¨³å®¶ã€ã§ã™ã€‚
â€¢ ãƒŸãƒƒã‚·ãƒ§ãƒ³: æŠ½è±¡çš„ãªãƒ‹ãƒ¼ã‚ºã‚’å…·ä½“çš„ãªæŠ€è¡“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„æ©Ÿèƒ½è¦ä»¶ã«åˆ†è§£ã™ã‚‹ã€‚
â€¢ ãŠé¡Œ: \${discussionTopic}
â€¢ å£èª¿: è«–ç†çš„ã€åˆ†æçš„ã€‚ã€Œã¤ã¾ã‚Šã€ã€Œè¦ã™ã‚‹ã«ã€`
            },
            "ã‚¢ã‚»ãƒƒãƒˆãƒ»ã‚¹ã‚«ã‚¦ãƒˆ": {
                api: "gemini",
                roleName: "ã‚¢ã‚»ãƒƒãƒˆãƒ»ã‚¹ã‚«ã‚¦ãƒˆ",
                prompt: `ã‚ãªãŸã¯ã€Œå¤–éƒ¨æŠ€è¡“ã®ç›£è¦–è€…ã€ã§ã™ã€‚
â€¢ ãƒŸãƒƒã‚·ãƒ§ãƒ³: ç«¶åˆã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã€ç‰¹è¨±ãªã©ã®å¤–éƒ¨å‹•å‘ï¼ˆæ¶ç©ºå¯ï¼‰ã‚’æç¤ºã—ã€Buy or Buildã‚’åˆ¤æ–­ã™ã‚‹ã€‚
â€¢ ãŠé¡Œ: \${discussionTopic}
â€¢ å£èª¿: ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ã€è¾›å£ã€æ—©å£ã€‚`
            },
            "ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼": {
                api: "openai",
                roleName: "ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼",
                prompt: `ã‚ãªãŸã¯ã€Œäº‹æ¥­ã¨å‡ºå£ã®è¨­è¨ˆè€…ã€ã§ã™ã€‚
â€¢ ãƒŸãƒƒã‚·ãƒ§ãƒ³: å…¨ã¦ã®è¦ç´ ã‚’çµ±åˆã—ã€ãƒãƒã‚¿ã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«ã¨å‡ºå£æˆ¦ç•¥ï¼ˆM&Aãªã©ï¼‰ã‚’æãã€‚
â€¢ ãŠé¡Œ: \${discussionTopic}
â€¢ å£èª¿: èµ·æ¥­å®¶çš„ã€åç›Šå¿—å‘ã€ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–ã€‚`
            },
            "ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ": {
                api: "user",
                roleName: "ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ"
            }
        };

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        buttons.startAuto.addEventListener('click', () => {
            if (!initializeSystem()) return;
            startAutoMode();
        });

        buttons.continueAuto.addEventListener('click', () => {
            currentTurnCount = 0; 
            updateTurnDisplay();
            panels.pauseMenu.style.display = 'none';
            buttons.forceStop.style.display = 'inline-block';
            orchestrateNextTurn("ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼");
        });

        buttons.summaryAuto.addEventListener('click', async () => {
            panels.pauseMenu.style.display = 'none';
            buttons.forceStop.style.display = 'none';
            await generateSummary();
        });

        buttons.forceStop.addEventListener('click', () => {
            isAutoMode = false;
            buttons.forceStop.style.display = 'none';
            panels.pauseMenu.style.display = 'block'; 
            addMessageToChat('system', 'è‡ªå‹•é€²è¡Œã‚’å¼·åˆ¶åœæ­¢ã—ã¾ã—ãŸã€‚');
        });

        buttons.expert.addEventListener('click', () => {
            const content = inputs.expert.value;
            if (!content) return;

            addMessageToChat("ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ", content);
            discussionHistory.push({ role: "ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ", content: content });
            inputs.expert.value = '';
            inputs.expert.disabled = true;
            buttons.expert.disabled = true;

            if (isAutoMode) {
                orchestrateNextTurn("ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼");
            }
        });

        // --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---

        function initializeSystem() {
            openAiApiKey = inputs.openai.value;
            geminiApiKey = inputs.gemini.value;
            discussionTopic = inputs.topic.value;

            if (!openAiApiKey || !geminiApiKey) {
                alert("APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return false;
            }
            
            Object.keys(PERSONAS).forEach(key => {
                if (PERSONAS[key].prompt) {
                    PERSONAS[key].prompt = PERSONAS[key].prompt.replace(/\$\{discussionTopic\}/g, discussionTopic);
                }
            });

            return true;
        }

        function startAutoMode() {
            isAutoMode = true;
            discussionHistory = [];
            chatWindow.innerHTML = '';
            currentTurnCount = 0;
            updateTurnDisplay();

            buttons.startAuto.style.display = 'none';
            buttons.forceStop.style.display = 'inline-block';
            panels.pauseMenu.style.display = 'none';

            addMessageToChat('system', `è­°è«–ã€Œ${discussionTopic}ã€ã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
            orchestrateNextTurn("ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼");
        }

        async function orchestrateNextTurn(roleName) {
            if (!isAutoMode) return;

            if (currentTurnCount >= MAX_TURNS_PER_ROUND) {
                pauseAutoMode();
                return;
            }

            if (roleName === "ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ") {
                addMessageToChat('system', '>> ã‚ãªãŸã®ç•ªã§ã™ã€‚å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                inputs.expert.disabled = false;
                buttons.expert.disabled = false;
                inputs.expert.focus();
                return; 
            }

            try {
                showTyping(true, roleName);
                
                const content = await callLLM(roleName);
                
                showTyping(false);
                
                const cleanContent = content.replace(/\[\[NEXT:.*?\]\]/g, '').trim();
                addMessageToChat(roleName, cleanContent);
                discussionHistory.push({ role: roleName, content: content });

                currentTurnCount++;
                updateTurnDisplay();

                if (roleName === "ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼") {
                    const nextMatch = content.match(/\[\[NEXT:\s*(.+?)\]\]/);
                    if (nextMatch && nextMatch[1]) {
                        let nextRole = nextMatch[1].trim();
                        if (!PERSONAS[nextRole]) {
                            nextRole = "ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼";
                        }
                        setTimeout(() => orchestrateNextTurn(nextRole), 1000);
                    } else {
                        setTimeout(() => orchestrateNextTurn("ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼"), 1000);
                    }
                } else {
                    setTimeout(() => orchestrateNextTurn("ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼"), 1000);
                }

            } catch (e) {
                showTyping(false);
                addMessageToChat('system', `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                console.error(e);
                isAutoMode = false;
                buttons.forceStop.style.display = 'none';
                buttons.startAuto.style.display = 'inline-block';
            }
        }

        function pauseAutoMode() {
            buttons.forceStop.style.display = 'none';
            panels.pauseMenu.style.display = 'block';
            addMessageToChat('system', 'è¦å®šã®ã‚¿ãƒ¼ãƒ³æ•°ã«é”ã—ã¾ã—ãŸã€‚æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        }

        // --- APIå‘¼ã³å‡ºã—é–¢æ•° ---

        async function callLLM(roleName) {
            const persona = PERSONAS[roleName];
            if (persona.api === 'openai') {
                return await callOpenAI(persona);
            } else {
                return await callGemini(persona);
            }
        }

        async function callGemini(persona) {
            let contents = formatHistoryForGemini(discussionHistory);

            if (contents.length === 0) {
                contents.push({
                    role: "user",
                    parts: [{ text: `è­°è«–é–‹å§‹: ${discussionTopic}\nã‚ãªãŸã®å½¹å‰²ã¨ã—ã¦è­°è«–ã‚’ãƒªãƒ¼ãƒ‰ã€ã¾ãŸã¯ç™ºè¨€ã—ã¦ãã ã•ã„ã€‚` }]
                });
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${geminiApiKey}`;
            
            // ã‚»ãƒ¼ãƒ•ãƒ†ã‚£è¨­å®š: è­°è«–ãŒä¸­æ–­ã•ã‚Œãªã„ã‚ˆã†ã«ç·©å’Œè¨­å®šã‚’è¿½åŠ 
            const safetySettings = [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
            ];

            const body = JSON.stringify({
                contents: contents,
                systemInstruction: { parts: [{ text: persona.prompt }] },
                generationConfig: { temperature: 0.7 },
                safetySettings: safetySettings
            });

            const maxRetries = 3;
            let retryDelay = 2000;

            for (let attempt = 1; attempt <= maxRetries + 1; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: body
                    });

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        if (response.status === 503 || response.status === 429) {
                            if (attempt <= maxRetries) {
                                showTyping(true, `${persona.roleName} (æ··é›‘ä¸­... ${attempt}å›ç›®ãƒªãƒˆãƒ©ã‚¤)`);
                                await new Promise(r => setTimeout(r, retryDelay));
                                retryDelay *= 2;
                                continue;
                            }
                        }
                        throw new Error(`Gemini Error ${response.status}: ${JSON.stringify(errData)}`);
                    }

                    const data = await response.json();
                    
                    // ã€ä¿®æ­£ã€‘ å³æ ¼ãªnullãƒã‚§ãƒƒã‚¯
                    // candidatesãŒå­˜åœ¨ã—ã€é•·ã•ãŒ0ä»¥ä¸Šã§ã€æœ€åˆã®è¦ç´ ã«contentãŒã‚ã‚‹ã‹ç¢ºèª
                    if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                        console.error("Empty Gemini Response:", data);
                        if (data.promptFeedback) {
                            throw new Error(`Safety Blocked: ${JSON.stringify(data.promptFeedback)}`);
                        }
                        throw new Error("Empty response from Gemini (Candidates missing)");
                    }
                    
                    return data.candidates[0].content.parts[0].text;

                } catch (e) {
                    if (attempt > maxRetries) throw e;
                    // è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ä»¥å¤–ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãŸã„å ´åˆã“ã“ã§åˆ†å²å¯èƒ½ã ãŒã€ä»Šå›ã¯ã‚¹ãƒ­ãƒ¼
                    throw e;
                }
            }
        }

        async function callOpenAI(persona) {
            let messages = [
                { role: "system", content: persona.prompt },
                ...formatHistoryForOpenAI(discussionHistory)
            ];

            if (messages.length === 1) {
                messages.push({ role: "user", content: `è­°è«–é–‹å§‹: ${discussionTopic}` });
            }

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${openAiApiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o", 
                    messages: messages,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "OpenAI Error");
            }
            const data = await response.json();
            
            // ã€ä¿®æ­£ã€‘å³æ ¼ãªnullãƒã‚§ãƒƒã‚¯
            if (!data.choices || data.choices.length === 0 || !data.choices[0].message) {
                console.error("Empty OpenAI Response:", data);
                throw new Error("Empty response from OpenAI");
            }
            
            return data.choices[0].message.content;
        }

        async function generateSummary() {
            showTyping(true, "ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ (ã¾ã¨ã‚ä½œæˆä¸­)");
            try {
                const prompt = "ã“ã‚Œã¾ã§ã®è­°è«–å…¨ä½“ã‚’æ•´ç†ã—ã€æ±ºå®šäº‹é …ã€æ®‹ã•ã‚ŒãŸèª²é¡Œã€ãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã¾ã¨ã‚ãŸã‚µãƒãƒªãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚";
                
                let history = formatHistoryForGemini(discussionHistory);
                history.push({ role: "user", parts: [{ text: prompt }] });

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL_NAME}:generateContent?key=${geminiApiKey}`;
                
                // ã¾ã¨ã‚ä½œæˆæ™‚ã‚‚ã‚»ãƒ¼ãƒ•ãƒ†ã‚£è¨­å®šã‚’è¿½åŠ 
                const safetySettings = [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                ];

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: history,
                        systemInstruction: { parts: [{ text: "ã‚ãªãŸã¯å„ªç§€ãªæ›¸è¨˜ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚" }] },
                        safetySettings: safetySettings
                    })
                });

                if (!response.ok) throw new Error("Summary Gen Error: " + response.status);
                const data = await response.json();
                
                if (!data.candidates || data.candidates.length === 0) {
                     throw new Error("Summary generation failed (Empty response)");
                }

                const summary = data.candidates[0].content.parts[0].text;
                
                showTyping(false);
                addMessageToChat("æœ€çµ‚ã¾ã¨ã‚", summary, "role-moderator");
                
                buttons.startAuto.style.display = 'inline-block';
                buttons.startAuto.innerText = 'ğŸ”„ æ–°ã—ã„è­°è«–ã‚’å§‹ã‚ã‚‹';

            } catch (e) {
                showTyping(false);
                addMessageToChat('system', `ã¾ã¨ã‚ä½œæˆã‚¨ãƒ©ãƒ¼: ${e.message}`);
                console.error(e);
            }
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---

        function addMessageToChat(role, content, customClass = '') {
            const div = document.createElement('div');
            div.classList.add('chat-message');
            
            const roleClassMap = {
                "ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼": "role-moderator",
                "ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ": "role-market",
                "ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ¼": "role-translator",
                "ã‚¢ã‚»ãƒƒãƒˆãƒ»ã‚¹ã‚«ã‚¦ãƒˆ": "role-scout",
                "ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼": "role-creator",
                "ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ»ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ": "role-expert",
                "system": "role-system"
            };

            div.classList.add(customClass || roleClassMap[role] || 'role-system');
            div.innerHTML = `<strong>${role}</strong>${content.replace(/\n/g, '<br>')}`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTyping(show, roleName = '') {
            typingIndicator.style.display = show ? 'block' : 'none';
            if (show) {
                if (roleName.includes("ãƒªãƒˆãƒ©ã‚¤")) {
                    typingIndicator.innerHTML = `<span class="retry-indicator">${roleName}</span>`;
                } else {
                    typingIndicator.innerText = `${roleName} ãŒå…¥åŠ›ä¸­...`;
                }
            }
        }

        function updateTurnDisplay() {
            turnDisplay.innerText = currentTurnCount;
        }

        function formatHistoryForOpenAI(history) {
            return history.map(item => {
                if (item.role === "ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ" || item.role === "ãƒ“ã‚¸ãƒã‚¹ãƒ»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼") {
                    return { role: "assistant", content: item.content };
                }
                return { role: "user", content: `[${item.role}]: ${item.content}` };
            });
        }

        function formatHistoryForGemini(history) {
            const contents = [];
            for (const item of history) {
                if (["ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼", "ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ãƒ¼", "ã‚¢ã‚»ãƒƒãƒˆãƒ»ã‚¹ã‚«ã‚¦ãƒˆ"].includes(item.role)) {
                    contents.push({ role: "model", parts: [{ text: item.content }] });
                } else {
                    contents.push({ role: "user", parts: [{ text: `[${item.role}]: ${item.content}` }] });
                }
            }
            return contents;
        }

    </script>
</body>
</html>